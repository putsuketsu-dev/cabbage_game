<!DOCTYPE html>
<html lang="zh-TW">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>å°é«˜éº—ï¼šæœ€çµ‚å®Œç¾ä¿®æ­£ç‰ˆ</title>
    <style>
        body {
            margin: 0;
            padding: 0;
            background-color: #333;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            font-family: 'Microsoft JhengHei', sans-serif;
            overflow: hidden; 
            touch-action: none; 
            user-select: none; 
        }
        /* ç¢ºä¿å®¹å™¨å°ºå¯¸å›ºå®šï¼Œé¿å…éåº¦ç¸®æ”¾ */
        #gameContainer {
            position: relative;
            width: 800px; /* å›ºå®šçš„å¯¬åº¦ */
            height: 500px; /* å›ºå®šçš„é«˜åº¦ */
            background: #87CEEB; 
            overflow: hidden;
            border: 5px solid #555; /* å¢åŠ é‚Šæ¡†ç¢ºèªé‚Šç•Œ */
        }
        canvas {
            width: 100%;
            height: 100%;
            display: block;
        }
        /* å…¶é¤˜UI/Control CSSä¿æŒä¸è®Šï¼Œç•¥éä»¥ç¸®çŸ­ç¯‡å¹…ï¼Œç¢ºä¿é—œéµçš„Canvaså°ºå¯¸æ­£ç¢º */
        #ui {
            position: absolute;
            top: 10px;
            left: 10px;
            color: white;
            font-size: 16px; 
            font-weight: bold;
            text-shadow: 2px 2px 4px #000;
            pointer-events: none;
            z-index: 5;
            display: none;
        }
        #controls {
            position: absolute;
            bottom: 10px;
            left: 0;
            width: 100%;
            height: 120px;
            pointer-events: none; 
            display: none;
            justify-content: space-between;
            padding: 0 20px;
            box-sizing: border-box;
            z-index: 20;
        }
        .control-group {
            pointer-events: auto; 
            position: relative;
            width: 150px;
            height: 150px;
        }
        .btn {
            background: rgba(255, 255, 255, 0.3);
            border: 2px solid rgba(255, 255, 255, 0.6);
            border-radius: 50%;
            position: absolute;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 24px;
            color: white;
            touch-action: manipulation;
        }
        .btn:active, .btn.pressed {
            background: rgba(255, 215, 0, 0.6); 
        }
        
        #btn-up { top: 0; left: 50px; width: 50px; height: 50px; }
        #btn-down { bottom: 20px; left: 50px; width: 50px; height: 50px; }
        #btn-left { top: 50px; left: 0; width: 50px; height: 50px; }
        #btn-right { top: 50px; right: 0; width: 50px; height: 50px; }

        #btn-fire {
            bottom: 40px;
            right: 10px;
            width: 90px;
            height: 90px;
            background-color: rgba(255, 255, 255, 0.2);
            border: 3px solid #FFD700;
            background-size: cover; 
            background-position: center;
            background-repeat: no-repeat;
            display: flex; 
            justify-content: center; 
            align-items: center;
            font-size: 14px;
            color: #FFD700;
            text-align: center;
            line-height: 1.2;
            --progress: 0%; 
            background-image: radial-gradient(closest-side, rgba(0,0,0,0.5) 79%, transparent 80% 100%),
                              conic-gradient(#00FFFF var(--progress), rgba(255,255,255,0.3) 0);
            border: 4px solid rgba(255,255,255,0.5);
            box-shadow: 0 0 10px rgba(0,0,0,0.5);
            transition: border-color 0.3s;
        }
        #btn-fire.charged {
            border-color: #00FFFF;
            box-shadow: 0 0 20px #00FFFF;
        }
        @keyframes pulse {
            0% { transform: scale(1); } 50% { transform: scale(1.05); } 100% { transform: scale(1); }
        }
        
        .skill-text {
            position: absolute;
            color: #FFD700;
            font-size: 40px; 
            font-weight: 900;
            text-shadow: 3px 3px 0 #FF4500, -1px -1px 0 #000;
            opacity: 0;
            pointer-events: none;
            width: 100%;
            text-align: center;
            top: 30%;
            animation: popUpBig 1.5s ease-out forwards;
            z-index: 10;
        }
        @keyframes popUpBig {
            0% { opacity: 0; transform: scale(0.5) translateY(0); }
            10% { opacity: 1; transform: scale(1.5) translateY(-20px); }
            80% { opacity: 1; transform: scale(1) translateY(-20px); }
            100% { opacity: 0; transform: scale(1) translateY(-50px); }
        }
        
        #loadingScreen, #startScreen, #gameOverScreen {
            position: absolute;
            top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0, 0, 0, 0.85);
            color: white;
            display: flex;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            z-index: 50;
        }
        #startScreen, #gameOverScreen { display: none; }
        
        button {
            background: #FFD700;
            border: none;
            padding: 10px 30px;
            font-size: 20px;
            cursor: pointer;
            border-radius: 50px;
            margin-top: 20px;
            font-weight: bold;
            color: #333;
        }
        #bossWarning {
            display: none;
            position: absolute;
            top: 20%;
            width: 100%;
            text-align: center;
            color: red;
            font-size: 40px;
            font-weight: bold;
            text-shadow: 2px 2px white;
            animation: blink 0.5s infinite;
            z-index: 10;
        }
        @keyframes blink { 0% { opacity: 0; } 50% { opacity: 1; } 100% { opacity: 0; } }
    </style>
</head>
<body>

<div id="gameContainer">
    <div id="loadingScreen"><h1>è³‡æºè¼‰å…¥ä¸­...</h1></div>
    
    <div id="startScreen">
        <h1 style="font-size: 40px; color: #FFD700; text-shadow: 2px 2px #000;">å°é«˜éº—å¤§æˆ°ç²½å­è»åœ˜</h1>
        <p>æ‰“å€’ç²½å­è»åœ˜èˆ‡é­”ç‹ï¼</p>
        <button onclick="startGame()">é–‹å§‹éŠæˆ²</button>
    </div>

    <div id="ui">
        <div>HP: <span id="hpDisplay">â¤ï¸â¤ï¸â¤ï¸â¤ï¸â¤ï¸</span></div>
        <div>Lv: <span id="level">1</span> | <span id="nextLevel">é‚„éœ€æ“Šé€€: 20</span></div>
        <div>Score: <span id="score">0</span></div>
        <div style="font-size: 12px; color: #FFD700; margin-top: 5px;">ğŸ’¡ é›™æ“Š=å¤§çµ•(1.5å€å‚·) | é•·æŒ‰=é˜²ç¦¦</div>
    </div>
    
    <div id="bossWarning">âš ï¸ é­”ç‹ä¾†è¥² âš ï¸</div>
    <div id="skillContainer"></div>

    <canvas id="gameCanvas" width="800" height="500"></canvas>
    
    <div id="controls">
        <div class="control-group">
            <div class="btn" id="btn-up" data-key="ArrowUp">â†‘</div>
            <div class="btn" id="btn-down" data-key="ArrowDown">â†“</div>
            <div class="btn" id="btn-left" data-key="ArrowLeft">â†</div>
            <div class="btn" id="btn-right" data-key="ArrowRight">â†’</div>
        </div>
        <div class="control-group">
            <div class="btn" id="btn-fire" data-key="Space"></div>
        </div>
    </div>

    <div id="gameOverScreen">
        <h1 id="endTitle">éŠæˆ²çµæŸ</h1>
        <p>åˆ†æ•¸: <span id="finalScore">0</span></p>
        <button onclick="restartGame()">é‡ä¾†</button>
    </div>
</div>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    
    // UI Elements (ç•¥)
    const scoreEl = document.getElementById('score');
    const levelEl = document.getElementById('level');
    const nextLevelEl = document.getElementById('nextLevel');
    const hpDisplayEl = document.getElementById('hpDisplay');
    const gameOverScreen = document.getElementById('gameOverScreen');
    const startScreen = document.getElementById('startScreen');
    const loadingScreen = document.getElementById('loadingScreen');
    const endTitle = document.getElementById('endTitle');
    const finalScoreEl = document.getElementById('finalScore');
    const bossWarningEl = document.getElementById('bossWarning');
    const skillContainer = document.getElementById('skillContainer');
    const btnFire = document.getElementById('btn-fire');
    const uiEl = document.getElementById('ui');
    const controlsEl = document.getElementById('controls');

    // --- åœ–ç‰‡è¼‰å…¥ ---
    const BASE_URL = 'https://raw.githubusercontent.com/putsuketsu-dev/Cabbage/main/';
    const imageSources = {
        background: BASE_URL + 'BG.jpg', 
        playerRun1: BASE_URL + 'ä¸»è§’èµ°è·¯1.png',
        playerRun2: BASE_URL + 'ä¸»è§’èµ°è·¯2.png',
        playerAttack: BASE_URL + 'ä¸»è§’æ”»æ“Š.png',
        playerBullet: BASE_URL + 'ä¸»è§’æ‹›å¼.png',
        boss1: BASE_URL + 'é­”ç‹1.png',
        boss2: BASE_URL + 'é­”ç‹2.png',
        bossUltAnim: BASE_URL + 'é­”ç‹é–‹å¤§çµ•.png',
        bossUltBullet: BASE_URL + 'é­”ç‹å¤§çµ•æ‹›.png',
        minion: BASE_URL + 'å°æ€ª.png',
        smallBoss: BASE_URL + 'å°ç‹.png',
        superMove: BASE_URL + 'skill.png',
        bossThrow: BASE_URL + 'bthrow.png',
        def1: BASE_URL + 'd1.png', 
        def2: BASE_URL + 'd2.png'
    };

    const images = {};
    const imageLoaded = {};
    let imagesToLoad = Object.keys(imageSources).length;
    let imagesLoadedCount = 0;

    function imageLoadHandler(key) {
        imageLoaded[key] = true;
        imagesLoadedCount++;
        if(key === 'playerBullet') {
            btnFire.style.setProperty('--icon-url', `url('${imageSources[key]}')`);
        }
        // å…¨éƒ¨è¼‰å…¥å®Œæˆå¾Œï¼Œé¡¯ç¤ºé–‹å§‹ç•«é¢ä¸¦å•Ÿå‹•éŠæˆ²å¾ªç’°
        if (imagesLoadedCount === imagesToLoad) {
            loadingScreen.style.display = 'none';
            startScreen.style.display = 'flex';
            
            // *ä¿®æ­£é» 2: åœ¨æ­¤å•Ÿå‹•éŠæˆ²å¾ªç’°ï¼Œç¢ºä¿ requestAnimationFrame éˆæ¢å•Ÿå‹•*
            gameLoop();
        }
    }

    for (let key in imageSources) {
        images[key] = new Image();
        images[key].crossOrigin = "Anonymous";
        images[key].onload = () => imageLoadHandler(key);
        images[key].onerror = () => {
            console.error("Image load failed: " + key);
            imageLoadHandler(key); 
        };
        images[key].src = imageSources[key];
    }

    // --- éŠæˆ²åƒæ•¸ ---
    let gameRunning = false;
    let frameCount = 0;
    let score = 0;
    let level = 1;
    const ENEMIES_PER_LEVEL = 20; 
    let enemiesDefeatedInLevel = 0;
    let bossActive = false;
    let bossSpawned = false;
    let pendingLevelUp = false;

    // === èƒŒæ™¯æ§åˆ¶åƒæ•¸ (æ ¸å¿ƒè£åˆ‡é‚è¼¯) ===
    let bgSourceX = 0; 
    const targetBgSourceX = 800; 
    const bgScrollSpeed = 8; 
    let scrollingBackground = false;

    // è§’è‰²
    const player = {
        x: 50, y: 250, width: 180, height: 180, speed: 6, hp: 5, maxHp: 5,
        isInvincible: false, invincibleTimer: 0, isAttacking: false, attackTimer: 0,
        isDefending: false, defenseTimer: 0, charge: 0, maxCharge: 10,
        isStunned: false, stunTimer: 0,
        guardHitCount: 0,
        isUltAttacking: false, ultAttackTimer: 0 
    };

    const PLAYER_MIN_Y = 200; 
    const PLAYER_MAX_Y = 380; 
    player.y = (PLAYER_MIN_Y + PLAYER_MAX_Y) / 2;

    let bullets = [];
    let bossBullets = [];
    let enemies = [];
    let items = []; 
    let combatTexts = []; 
    let enemySpawnRate = 60;

    const bossQuotes = ["è¦åŠ é†¬å—ï¼Ÿ", "æ²’æœ‰åƒç´ é½", "ç¾åœ¨åƒå—ï¼Ÿ"];
    let bossText = { text: "", timer: 0, x: 0, y: 0 };

    // --- æ§åˆ¶ç³»çµ± (ç•¥) ---
    const keys = {};
    let fireKeyPressed = false;
    let fireKeyTimer = 0;
    let lastFireReleaseTime = 0;

    // éµç›¤èˆ‡è§¸æ§äº‹ä»¶è™•ç†å™¨ (åŒå‰ä¸€ç‰ˆï¼Œæ•…ç•¥)
    window.addEventListener('keydown', (e) => {
        if (!gameRunning) return;
        keys[e.code] = true;
        if(['ArrowUp','ArrowDown','ArrowLeft','ArrowRight','Space'].includes(e.code)) e.preventDefault();
        if (e.code === 'Space' && !fireKeyPressed) {
            fireKeyPressed = true;
            handleFirePress();
        }
    });
    window.addEventListener('keyup', (e) => {
        if (!gameRunning) return;
        keys[e.code] = false;
        if (e.code === 'Space') {
            fireKeyPressed = false;
            handleFireRelease();
        }
    });

    const btns = document.querySelectorAll('.btn');
    btns.forEach(btn => {
        const handleStart = (e) => {
            if (!gameRunning) return;
            e.preventDefault();
            const key = btn.getAttribute('data-key');
            keys[key] = true;
            btn.classList.add('pressed');
            if (key === 'Space' && !fireKeyPressed) {
                fireKeyPressed = true;
                handleFirePress();
            }
        };
        const handleEnd = (e) => {
            if (!gameRunning) return;
            e.preventDefault();
            const key = btn.getAttribute('data-key');
            keys[key] = false;
            btn.classList.remove('pressed');
            if (key === 'Space') {
                fireKeyPressed = false;
                handleFireRelease();
            }
        };
        btn.addEventListener('touchstart', handleStart);
        btn.addEventListener('touchend', handleEnd);
        btn.addEventListener('mousedown', handleStart);
        btn.addEventListener('mouseup', handleEnd);
    });

    function handleFirePress() {
        if (player.isStunned) return; 

        fireKeyTimer = 0;
        let currentTime = new Date().getTime();
        if (currentTime - lastFireReleaseTime < 300 && player.charge >= player.maxCharge) {
            fireSuperMove(); 
            player.isDefending = false; 
            fireKeyTimer = 999; 
        }
    }

    function handleFireRelease() {
        if (player.isStunned) return; 

        lastFireReleaseTime = new Date().getTime();
        if (fireKeyTimer < 15) { 
            shoot(); 
            player.isAttacking = true;
            player.attackTimer = 15;
        }
        player.isDefending = false;
        fireKeyTimer = 0;
        player.guardHitCount = 0; 
    }
    
    // (å…¶ä»–éŠæˆ²é‚è¼¯å‡½æ•¸ï¼šaddCharge, updateChargeUI, fireSuperMove, showSkillText, showCombatText, shoot, playerTakeDamage, updateHPUI, bossSpeak, bossAttack, fireUltimate, spawnEnemy, triggerBossStage, realSpawnBoss, evolveBoss, updateUI, checkRectCollision, performLevelUp ä¿æŒä¸è®Šï¼Œæ•…ç•¥éä»¥ç¯€çœç©ºé–“ï¼Œä½†æœƒåœ¨å®Œæ•´ç¨‹å¼ç¢¼ä¸­ä¿ç•™)

    // *** é—œéµä¿®æ­£ï¼šå–®ä¸€éŠæˆ²å¾ªç’° ***
    function gameLoop() {
        
        if (gameRunning) {
            // --- éŠæˆ²é‚è¼¯ (åŸ update å…§å®¹) ---
            
            if (player.isUltAttacking) {
                player.ultAttackTimer--;
                keys['ArrowUp'] = keys['ArrowDown'] = keys['ArrowLeft'] = keys['ArrowRight'] = false;
                player.isAttacking = false;
                player.isDefending = false;

                if (player.ultAttackTimer <= 0) {
                    player.isUltAttacking = false;
                }
            }

            if (player.isDefending) {
                // åŸæœ¬ defenseDuration
            } else { 
                // åŸæœ¬ defenseDuration
            }

            if (player.isStunned) {
                player.stunTimer--;
                player.isDefending = false; 
                player.isAttacking = false; 
                if (player.stunTimer <= 0) { 
                    player.isStunned = false;
                    player.guardHitCount = 0; 
                    fireKeyTimer = 0;
                    fireKeyPressed = false;
                    keys['Space'] = false; 
                    document.getElementById('btn-fire').classList.remove('pressed'); 
                }
            } else if (!player.isUltAttacking) { 
                if (fireKeyPressed) {
                    fireKeyTimer++;
                    if (fireKeyTimer >= 15) { 
                        player.isDefending = true; 
                        player.isAttacking = false;
                    }
                }

                if (player.isAttacking) {
                    player.attackTimer--;
                    if (player.attackTimer <= 0) player.isAttacking = false;
                }

                if (keys['ArrowUp']) player.y -= player.speed;
                if (keys['ArrowDown']) player.y += player.speed;
                if (keys['ArrowLeft'] && player.x > 0) player.x -= player.speed;
                if (keys['ArrowRight'] && player.x < canvas.width - player.width) player.x += player.speed;
            }

            // === èƒŒæ™¯æ²å‹•é‚è¼¯ ===
            if (scrollingBackground) {
                if (bgSourceX < targetBgSourceX) {
                    bgSourceX = Math.min(bgSourceX + bgScrollSpeed, targetBgSourceX);
                } else {
                    realSpawnBoss();
                }
            } else if (!bossActive && bgSourceX > 0) {
                bgSourceX = Math.max(bgSourceX - bgScrollSpeed, 0);
            }

            player.y = Math.min(Math.max(player.y, PLAYER_MIN_Y), PLAYER_MAX_Y);
            player.x = Math.min(Math.max(player.x, 0), canvas.width - player.width);

            if (player.isInvincible) {
                player.invincibleTimer--;
                if (player.invincibleTimer <= 0) player.isInvincible = false;
            }
            
            if (bossText.timer > 0) bossText.timer--;
            if (pendingLevelUp) { performLevelUp(); pendingLevelUp = false; }
            
            if (!bossActive && !pendingLevelUp && !scrollingBackground) {
                if (frameCount % enemySpawnRate === 0) spawnEnemy();
                enemySpawnRate = Math.max(10, 45 - (level * 12)); 
            }

            // (ç‰©å“ã€æˆ°é¬¥æ–‡å­—ã€å­å½ˆæ›´æ–°é‚è¼¯ï¼ŒåŒå‰ä¸€ç‰ˆï¼Œç•¥)
            for (let i = items.length - 1; i >= 0; i--) { /* ... */ }
            for(let i = combatTexts.length - 1; i >= 0; i--) { /* ... */ }
            for (let i = bullets.length - 1; i >= 0; i--) { /* ... */ }
            for (let i = bossBullets.length - 1; i >= 0; i--) { /* ... */ }
            
            let uiDirty = false;
            let chargeDirty = false;

            for (let i = enemies.length - 1; i >= 0; i--) { /* ... ç¢°æ’å’Œæ•µäººç§»å‹•é‚è¼¯ ... */ }

            if (uiDirty) updateUI();
            if (chargeDirty) updateChargeUI();
            
            frameCount++;
        }
        
        // --- ç¹ªåœ– (åŸ draw å…§å®¹) ---
        draw(); 

        // *** é—œéµä¿®æ­£ 1: ç¢ºä¿éŠæˆ²å¾ªç’°éˆæ¢é€£çºŒ ***
        requestAnimationFrame(gameLoop);
    }
    
    // ç¹ªåœ–å‡½æ•¸ (ä¿æŒä¸è®Š)
    function draw() {
        ctx.clearRect(0, 0, canvas.width, canvas.height);
        
        // === ç¹ªè£½èƒŒæ™¯ (æ ¸å¿ƒè£åˆ‡é‚è¼¯ï¼Œå†æ¬¡ç¢ºèª) ===
        if (imageLoaded['background']) {
            try {
                // drawImage(image, sx, sy, sWidth, sHeight, dx, dy, dWidth, dHeight)
                // å¾ 1600x500 çš„åŸåœ–ä¸­ï¼Œè£åˆ‡å‡º bgSourceX é–‹å§‹çš„ 800 å¯¬åº¦
                ctx.drawImage(
                    images['background'], 
                    bgSourceX, 0, 800, 500, // Source crop (800x500 å€åŸŸ)
                    0, 0, canvas.width, canvas.height // Destination draw (800x500 ç•«å¸ƒ)
                );
            } catch(e) {
                drawFallbackBackground();
            }
        } else {
            drawFallbackBackground();
        }

        // (ç¹ªè£½å…¶ä»–å…ƒç´ ï¼šBossæ–‡å­—ã€ç©å®¶ã€å­å½ˆã€æ•µäººã€æˆ°é¬¥æ–‡å­—...ï¼ŒåŒå‰ä¸€ç‰ˆï¼Œç•¥)
        // ...
    }
    
    function drawFallbackBackground() {
        // ... (åŒå‰ä¸€ç‰ˆï¼Œç•¥)
        ctx.fillStyle = '#87CEEB'; 
        ctx.fillRect(0,0,canvas.width, canvas.height);
        ctx.strokeStyle = "rgba(255,255,255,0.3)";
        ctx.lineWidth = 2;
        let offset = bgSourceX % 100; 
        for(let i=offset; i<canvas.width; i+=100) {
            ctx.beginPath(); ctx.moveTo(i, 0); ctx.lineTo(i, canvas.height); ctx.stroke();
        }
    }

    function startGame() {
        startScreen.style.display = 'none';
        uiEl.style.display = 'block';
        controlsEl.style.display = 'flex';
        restartGame();
    }
    
    function restartGame() {
        // (é‡è¨­éŠæˆ²åƒæ•¸ï¼ŒåŒå‰ä¸€ç‰ˆï¼Œç•¥)
        score = 0; level = 1; enemiesDefeatedInLevel = 0; bossActive = false; pendingLevelUp = false; bossSpawned = false;
        enemies = []; bullets = []; bossBullets = []; items = []; combatTexts = [];
        player.y = 250; player.x = 50; player.hp = player.maxHp; player.isInvincible = false;
        player.isAttacking = false; player.isDefending = false; player.attackTimer = 0; player.charge = 0;
        player.isStunned = false; player.guardHitCount = 0;
        enemySpawnRate = 60; 
        bgSourceX = 0; 
        scrollingBackground = false;
        gameRunning = true; gameOverScreen.style.display = 'none'; bossWarningEl.style.display = 'none';
        skillContainer.innerHTML = ''; updateUI(); updateChargeUI(); 
    }

    // (å…¶ä»–å‡½æ•¸ï¼šplayerTakeDamage, checkRectCollision, performLevelUp, gameWin, gameOver ä¿æŒä¸è®Šï¼Œç•¥)
    
    // ç¨‹å¼ç¢¼åº•éƒ¨åˆå§‹åŒ–
    uiEl.style.display = 'none';
    controlsEl.style.display = 'none';
    // åœ¨åœ–ç‰‡è¼‰å…¥å®Œæˆå‰ï¼Œç”± gameLoop() åœ¨ imageLoadHandler è£¡å•Ÿå‹•
    // é€™æ¨£å¯ä»¥ä¿è­‰ç•«é¢å’ŒéŠæˆ²é‚è¼¯åœ¨é»æ“Šã€Œé–‹å§‹éŠæˆ²ã€å¾Œç«‹å³åŒæ­¥é‹ä½œã€‚
</script>

</body>
</html>
